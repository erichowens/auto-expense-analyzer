<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Expense Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .setup-alert { border-left: 4px solid #ffc107; }
        .credential-warning { border-left: 4px solid #dc3545; }
        .review-needed { border-left: 4px solid #0d6efd; }
        .status-indicator { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 8px;
        }
        .status-pending { background-color: #ffc107; }
        .status-ready { background-color: #198754; }
        .status-error { background-color: #dc3545; }
        .progress-container { min-height: 200px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-calculator me-2"></i>Travel Expense Analyzer</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/setup"><i class="fas fa-cog me-1"></i>Setup</a>
                <a class="nav-link" href="/trips"><i class="fas fa-plane me-1"></i>Trips</a>
                <a class="nav-link" href="/receipts"><i class="fas fa-receipt me-1"></i>Receipts</a>
                <a class="nav-link" href="/concur"><i class="fas fa-upload me-1"></i>Submit to Concur</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Travel Expense Dashboard</h1>
                <p class="text-muted">Automated expense analysis and Concur submission</p>
            </div>
        </div>

        <!-- Setup Status Alerts -->
        <div class="row mb-4">
            <div class="col-12">
                <h3>Setup Status</h3>
                
                <!-- Plaid API Setup -->
                <div class="alert setup-alert" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-university me-2"></i>
                            <strong>Plaid Bank Connection</strong>
                            <p class="mb-0 small">Required for automatic transaction fetching from Chase</p>
                        </div>
                        <div>
                            <span class="status-indicator status-pending" id="plaid-status"></span>
                            <button class="btn btn-sm btn-warning" onclick="initiatePlaidLink()" id="plaid-link-btn">
                                <i class="fas fa-link me-1"></i>Connect Bank
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="checkPlaidStatus()" id="plaid-test-btn" style="display: none;">
                                <i class="fas fa-check me-1"></i>Test
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 small">
                        <strong>Needs:</strong> Plaid developer account, Client ID, Secret, Access Token
                        <a href="/setup#plaid" class="ms-2">Setup Guide →</a>
                    </div>
                </div>

                <!-- Concur API Setup -->
                <div class="alert credential-warning" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-cloud me-2"></i>
                            <strong>SAP Concur API</strong>
                            <p class="mb-0 small">Required for automatic expense report submission</p>
                        </div>
                        <div>
                            <span class="status-indicator status-pending" id="concur-status"></span>
                            <button class="btn btn-sm btn-danger" onclick="testConcurConnection()">
                                <i class="fas fa-check me-1"></i>Test Connection
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 small">
                        <strong>Needs:</strong> Concur developer access, Client ID, Secret, Refresh Token
                        <a href="/setup#concur" class="ms-2">Setup Guide →</a>
                    </div>
                </div>

                <!-- Hotel Website Access -->
                <div class="alert setup-alert" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-hotel me-2"></i>
                            <strong>Hotel Loyalty Accounts</strong>
                            <p class="mb-0 small">Optional: For automatic folio retrieval</p>
                        </div>
                        <div>
                            <span class="status-indicator status-pending" id="hotel-status"></span>
                            <button class="btn btn-sm btn-warning" onclick="checkHotelAccess()">
                                <i class="fas fa-check me-1"></i>Check Access
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 small">
                        <strong>Needs:</strong> Marriott, Hilton, Hyatt, IHG loyalty account credentials
                        <a href="/setup#hotels" class="ms-2">Setup Guide →</a>
                    </div>
                </div>

                <!-- Email Access -->
                <div class="alert setup-alert" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-envelope me-2"></i>
                            <strong>Email Access</strong>
                            <p class="mb-0 small">Optional: For hotel confirmation parsing</p>
                        </div>
                        <div>
                            <span class="status-indicator status-pending" id="email-status"></span>
                            <button class="btn btn-sm btn-warning" onclick="checkEmailAccess()">
                                <i class="fas fa-check me-1"></i>Test Access
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 small">
                        <strong>Needs:</strong> Gmail app password or IMAP credentials
                        <a href="/setup#email" class="ms-2">Setup Guide →</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <h3>Quick Actions</h3>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="startAnalysis()">
                        <i class="fas fa-search me-1"></i>Analyze Expenses
                    </button>
                    <button class="btn btn-secondary" onclick="uploadCSV()">
                        <i class="fas fa-upload me-1"></i>Upload CSV Files
                    </button>
                    <button class="btn btn-info" onclick="retrieveFolios()">
                        <i class="fas fa-download me-1"></i>Get Hotel Folios
                    </button>
                    <button class="btn btn-success" onclick="createConcurReports()">
                        <i class="fas fa-paper-plane me-1"></i>Submit to Concur
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="row mb-4" id="progress-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Processing Status</h5>
                    </div>
                    <div class="card-body progress-container">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" id="main-progress" style="width: 0%"></div>
                        </div>
                        <div id="status-text">Ready to start...</div>
                        <div id="status-details" class="mt-2 small text-muted"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Trips Found</h5>
                        <h2 class="text-primary" id="trip-count">{{ trips|length }}</h2>
                        <small class="text-muted">Travel episodes identified</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Expenses</h5>
                        <h2 class="text-success" id="total-amount">
                            ${{ "%.2f"|format(trips|map(attribute='total_amount')|sum) if trips else 0 }}
                        </h2>
                        <small class="text-muted">Travel expenses</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Needs Review</h5>
                        <h2 class="text-warning" id="review-count">
                            {{ trips|selectattr('category_breakdown')|selectattr('OTHER')|list|length }}
                        </h2>
                        <small class="text-muted">Uncategorized expenses</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Last Analysis</h5>
                        <h6 class="text-info" id="last-analysis">
                            {% if last_analysis %}
                                {{ last_analysis[:10] }}
                            {% else %}
                                Never
                            {% endif %}
                        </h6>
                        <small class="text-muted">Data freshness</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trips Preview -->
        {% if trips %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Trips</h5>
                        <a href="/trips" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Destination</th>
                                        <th>Dates</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trip in trips[:5] %}
                                    <tr>
                                        <td>
                                            <strong>{{ trip.primary_location }}</strong>
                                            <br><small class="text-muted">{{ trip.transaction_count }} transactions</small>
                                        </td>
                                        <td>
                                            {{ trip.start_date }} to<br>{{ trip.end_date }}
                                            <br><small class="text-muted">{{ trip.duration_days }} days</small>
                                        </td>
                                        <td>
                                            <strong>${{ "%.2f"|format(trip.total_amount) }}</strong>
                                            {% if trip.category_breakdown.get('OTHER', 0) > 0 %}
                                            <br><small class="text-warning">
                                                <i class="fas fa-exclamation-triangle"></i> 
                                                ${{ "%.2f"|format(trip.category_breakdown.OTHER) }} uncategorized
                                            </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if trip.category_breakdown.get('OTHER', 0) > 0 %}
                                                <span class="badge bg-warning">Needs Review</span>
                                            {% else %}
                                                <span class="badge bg-success">Ready</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="/trips#trip-{{ trip.trip_number }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i> Review
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Modals -->
    <div class="modal fade" id="csvUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Chase CSV Files</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Upload your Chase bank statement CSV files for analysis.</p>
                    <input type="file" class="form-control" id="csvFiles" multiple accept=".csv">
                    <div class="mt-3">
                        <label for="analysisYears" class="form-label">Analysis Period (Years)</label>
                        <select class="form-select" id="analysisYears">
                            <option value="1">Last 1 Year</option>
                            <option value="2" selected>Last 2 Years</option>
                            <option value="3">Last 3 Years</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processCSVFiles()">Analyze</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script>
        let currentTaskId = null;
        let plaidHandler = null;

        function initiatePlaidLink() {
            updateStatusIndicator('plaid-status', 'pending');
            document.getElementById('plaid-link-btn').disabled = true;
            
            // Get Link token from server
            fetch('/api/create-link-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: 'default_user' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.link_token) {
                    initializePlaidLink(data.link_token);
                } else {
                    throw new Error(data.error || 'Failed to create link token');
                }
            })
            .catch(error => {
                updateStatusIndicator('plaid-status', 'error');
                document.getElementById('plaid-link-btn').disabled = false;
                alert(`Plaid connection failed: ${error.message}`);
            });
        }

        function initializePlaidLink(linkToken) {
            plaidHandler = Plaid.create({
                token: linkToken,
                onSuccess: (public_token, metadata) => {
                    // Exchange public token for access token
                    exchangePlaidToken(public_token, metadata);
                },
                onLoad: () => {
                    document.getElementById('plaid-link-btn').disabled = false;
                },
                onExit: (err, metadata) => {
                    document.getElementById('plaid-link-btn').disabled = false;
                    if (err != null) {
                        console.error('Plaid Link exit error:', err);
                        updateStatusIndicator('plaid-status', 'error');
                    }
                },
                onEvent: (eventName, metadata) => {
                    console.log('Plaid Link event:', eventName, metadata);
                }
            });
            
            plaidHandler.open();
        }

        function exchangePlaidToken(publicToken, metadata) {
            fetch('/api/exchange-public-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    public_token: publicToken,
                    metadata: metadata
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    updateStatusIndicator('plaid-status', 'ready');
                    document.getElementById('plaid-link-btn').innerHTML = '<i class="fas fa-check me-1"></i>Connected';
                    document.getElementById('plaid-link-btn').className = 'btn btn-sm btn-success';
                    document.getElementById('plaid-test-btn').style.display = 'inline-block';
                    alert(`Successfully connected ${metadata.institution.name}!`);
                } else {
                    throw new Error(data.error || 'Token exchange failed');
                }
            })
            .catch(error => {
                updateStatusIndicator('plaid-status', 'error');
                alert(`Token exchange failed: ${error.message}`);
            });
        }

        function checkPlaidStatus() {
            updateStatusIndicator('plaid-status', 'pending');
            
            fetch('/api/test-plaid-connection', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateStatusIndicator('plaid-status', 'ready');
                        alert(`Connection OK: ${data.accounts} accounts found`);
                    } else {
                        updateStatusIndicator('plaid-status', 'error');
                        alert(`Connection failed: ${data.message}`);
                    }
                })
                .catch(error => {
                    updateStatusIndicator('plaid-status', 'error');
                    alert('Connection test failed');
                });
        }

        function testConcurConnection() {
            fetch('/api/test-concur-connection', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateStatusIndicator('concur-status', 'ready');
                        alert(`Connected as: ${data.user}`);
                    } else {
                        updateStatusIndicator('concur-status', 'error');
                        alert(`Connection failed: ${data.message}`);
                    }
                })
                .catch(error => {
                    updateStatusIndicator('concur-status', 'error');
                    alert('Connection test failed');
                });
        }

        function checkHotelAccess() {
            updateStatusIndicator('hotel-status', 'pending');
        }

        function checkEmailAccess() {
            updateStatusIndicator('email-status', 'pending');
        }

        function updateStatusIndicator(elementId, status) {
            const indicator = document.getElementById(elementId);
            indicator.className = `status-indicator status-${status}`;
        }

        function startAnalysis() {
            document.getElementById('progress-section').style.display = 'block';
            updateProgress(0, 'Starting analysis...');
            
            fetch('/api/analyze-transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ use_plaid: true, years: 2 })
            })
            .then(response => response.json())
            .then(data => {
                currentTaskId = data.task_id;
                pollTaskStatus();
            })
            .catch(error => {
                updateProgress(0, 'Error starting analysis', error.message);
            });
        }

        function uploadCSV() {
            new bootstrap.Modal(document.getElementById('csvUploadModal')).show();
        }

        function processCSVFiles() {
            const files = document.getElementById('csvFiles').files;
            const years = document.getElementById('analysisYears').value;
            
            if (files.length === 0) {
                alert('Please select CSV files');
                return;
            }
            
            // Implementation would upload and process files
            bootstrap.Modal.getInstance(document.getElementById('csvUploadModal')).hide();
            updateProgress(0, 'Processing CSV files...');
        }

        function retrieveFolios() {
            updateProgress(0, 'Retrieving hotel folios...');
            
            fetch('/api/retrieve-folios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ search_email: true, download_folios: true })
            })
            .then(response => response.json())
            .then(data => {
                currentTaskId = data.task_id;
                pollTaskStatus();
            });
        }

        function createConcurReports() {
            if (confirm('Create expense reports in Concur for all trips?')) {
                updateProgress(0, 'Creating Concur reports...');
                
                fetch('/api/create-concur-reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ submit_reports: false })
                })
                .then(response => response.json())
                .then(data => {
                    currentTaskId = data.task_id;
                    pollTaskStatus();
                });
            }
        }

        function pollTaskStatus() {
            if (!currentTaskId) return;
            
            fetch(`/api/task-status/${currentTaskId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data.progress, data.description, data.status);
                    
                    if (data.status === 'running') {
                        setTimeout(pollTaskStatus, 1000);
                    } else if (data.status === 'completed') {
                        updateProgress(100, 'Completed successfully!');
                        setTimeout(() => location.reload(), 2000);
                    } else if (data.status === 'error') {
                        updateProgress(0, 'Error occurred', data.error);
                    }
                });
        }

        function updateProgress(percent, text, details = '') {
            document.getElementById('main-progress').style.width = `${percent}%`;
            document.getElementById('status-text').textContent = text;
            document.getElementById('status-details').textContent = details;
        }
    </script>
</body>
</html>