<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concur Submission - Travel Expense Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
    <style>
        .submission-step { border-left: 4px solid #dee2e6; transition: all 0.3s; }
        .submission-step.active { border-left-color: #0d6efd; background-color: #f8f9fa; }
        .submission-step.completed { border-left-color: #198754; }
        .submission-step.error { border-left-color: #dc3545; }
        .trip-preview { border: 1px solid #dee2e6; border-radius: 8px; transition: all 0.2s; }
        .trip-preview:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .trip-preview.selected { border-color: #0d6efd; background-color: #e7f1ff; }
        .policy-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .validation-error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .submission-success { background-color: #d1e7dd; border: 1px solid #badbcc; }
        .expense-breakdown { font-size: 0.9em; }
        .step-indicator { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: #dee2e6; 
            color: #6c757d;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold;
            margin-right: 15px;
        }
        .step-indicator.active { background: #0d6efd; color: white; }
        .step-indicator.completed { background: #198754; color: white; }
        .step-indicator.error { background: #dc3545; color: white; }
        .concur-preview { background: #f8f9fa; border: 1px dashed #dee2e6; }
        .status-timeline { position: relative; }
        .status-timeline::before { 
            content: ''; 
            position: absolute; 
            left: 20px; 
            top: 0; 
            bottom: 0; 
            width: 2px; 
            background: #dee2e6; 
        }
        .timeline-item { 
            position: relative; 
            padding-left: 50px; 
            margin-bottom: 20px; 
        }
        .timeline-icon { 
            position: absolute; 
            left: 0; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: white; 
            border: 3px solid #dee2e6; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .timeline-icon.completed { border-color: #198754; color: #198754; }
        .timeline-icon.active { border-color: #0d6efd; color: #0d6efd; }
        .timeline-icon.pending { border-color: #ffc107; color: #ffc107; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-calculator me-2"></i>Travel Expense Analyzer</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Dashboard</a>
                <a class="nav-link" href="/setup"><i class="fas fa-cog me-1"></i>Setup</a>
                <a class="nav-link" href="/trips"><i class="fas fa-plane me-1"></i>Trips</a>
                <a class="nav-link" href="/receipts"><i class="fas fa-receipt me-1"></i>Receipts</a>
                <a class="nav-link active" href="/concur"><i class="fas fa-upload me-1"></i>Submit to Concur</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1>Submit to SAP Concur</h1>
                <p class="text-muted">Review and submit expense reports to your Concur system</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary" onclick="testConcurConnection()">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
                <button class="btn btn-success" onclick="submitAllReady()">
                    <i class="fas fa-paper-plane me-1"></i>Submit All Ready
                </button>
            </div>
        </div>

        <!-- Concur Connection Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" id="connection-status">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-circle text-secondary" id="connection-indicator"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">SAP Concur Connection</h6>
                            <small class="text-muted" id="connection-message">Connection status unknown</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshConnection()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submission Steps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Submission Process</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="submission-step p-3 h-100" id="step-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="step-indicator">1</div>
                                        <h6 class="mb-0">Select Trips</h6>
                                    </div>
                                    <p class="small text-muted mb-0">Choose which trips to submit</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="submission-step p-3 h-100" id="step-2">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="step-indicator">2</div>
                                        <h6 class="mb-0">Review & Validate</h6>
                                    </div>
                                    <p class="small text-muted mb-0">Check for completeness</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="submission-step p-3 h-100" id="step-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="step-indicator">3</div>
                                        <h6 class="mb-0">Create Reports</h6>
                                    </div>
                                    <p class="small text-muted mb-0">Generate in Concur</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="submission-step p-3 h-100" id="step-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="step-indicator">4</div>
                                        <h6 class="mb-0">Submit</h6>
                                    </div>
                                    <p class="small text-muted mb-0">Send for approval</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Select Trips for Submission</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllTrips()">
                                <i class="fas fa-check-double me-1"></i>Select All Ready
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllSelections()">
                                <i class="fas fa-times me-1"></i>Clear All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for trip in trips %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="trip-preview p-3" data-trip="{{ trip.trip_number }}" onclick="toggleTripSelection({{ trip.trip_number }})">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="trip-{{ trip.trip_number }}" 
                                               data-trip="{{ trip.trip_number }}">
                                        <label class="form-check-label w-100" for="trip-{{ trip.trip_number }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">{{ trip.primary_location }}</h6>
                                                    <small class="text-muted">{{ trip.start_date }} - {{ trip.end_date }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold text-primary">${{ "%.2f"|format(trip.total_amount) }}</div>
                                                    {% if trip.get('validation_status') == 'ready' %}
                                                        <span class="badge bg-success">Ready</span>
                                                    {% elif trip.get('validation_status') == 'warning' %}
                                                        <span class="badge bg-warning">Warnings</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Issues</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="expense-breakdown mt-2">
                                                {% for category, amount in trip.category_breakdown.items() %}
                                                    <span class="badge bg-light text-dark me-1">{{ category }}: ${{ "%.0f"|format(amount) }}</span>
                                                {% endfor %}
                                            </div>
                                            
                                            <div class="mt-2">
                                                <div class="d-flex justify-content-between">
                                                    <small class="text-muted">{{ trip.transaction_count }} expenses</small>
                                                    <small class="text-muted">
                                                        {% set receipt_count = trip.get('receipt_count', 0) %}
                                                        {{ receipt_count }}/{{ trip.transaction_count }} receipts
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <!-- Validation Issues -->
                                            {% if trip.get('validation_issues') %}
                                            <div class="validation-error mt-2 p-2 rounded">
                                                <small>
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    Issues: {{ trip.validation_issues|join(', ') }}
                                                </small>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Policy Warnings -->
                                            {% if trip.get('policy_warnings') %}
                                            <div class="policy-warning mt-2 p-2 rounded">
                                                <small>
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    {{ trip.policy_warnings|join(', ') }}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if not trips %}
                        <div class="text-center text-muted p-5">
                            <i class="fas fa-inbox fa-4x mb-3"></i>
                            <h5>No trips found</h5>
                            <p>Analyze your expenses first to identify trips.</p>
                            <a href="/" class="btn btn-primary">Go to Dashboard</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Results -->
        <div class="row mb-4" id="validation-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Validation Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="validation-results"></div>
                        
                        <div class="mt-3">
                            <button class="btn btn-warning" onclick="fixIssuesAutomatically()">
                                <i class="fas fa-magic me-1"></i>Try Auto-Fix
                            </button>
                            <button class="btn btn-primary" onclick="proceedWithWarnings()">
                                <i class="fas fa-arrow-right me-1"></i>Proceed Anyway
                            </button>
                            <button class="btn btn-secondary" onclick="cancelSubmission()">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Concur Preview -->
        <div class="row mb-4" id="preview-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Concur Report Preview</h5>
                        <small class="text-muted">Preview of what will be created in Concur</small>
                    </div>
                    <div class="card-body">
                        <div id="concur-preview-content"></div>
                        
                        <div class="mt-4">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="auto-submit-checkbox">
                                <label class="form-check-label" for="auto-submit-checkbox">
                                    Automatically submit reports for approval after creation
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="attach-receipts-checkbox" checked>
                                <label class="form-check-label" for="attach-receipts-checkbox">
                                    Attach receipt images to expense entries
                                </label>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="createConcurReports()">
                                    <i class="fas fa-plus me-1"></i>Create Reports in Concur
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportForManualEntry()">
                                    <i class="fas fa-download me-1"></i>Export for Manual Entry
                                </button>
                                <button class="btn btn-outline-secondary" onclick="saveAsDraft()">
                                    <i class="fas fa-save me-1"></i>Save as Draft
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submission Status -->
        <div class="row mb-4" id="submission-status" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Submission Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="status-timeline" id="status-timeline"></div>
                        
                        <div class="mt-4">
                            <div class="progress mb-3">
                                <div class="progress-bar" id="submission-progress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="submission-message">Preparing submission...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submission Results -->
        <div class="row mb-4" id="results-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Submission Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="submission-results"></div>
                        
                        <div class="mt-4">
                            <button class="btn btn-primary" onclick="viewInConcur()">
                                <i class="fas fa-external-link-alt me-1"></i>View Reports in Concur
                            </button>
                            <button class="btn btn-outline-success" onclick="downloadSubmissionReport()">
                                <i class="fas fa-download me-1"></i>Download Summary
                            </button>
                            <button class="btn btn-outline-primary" onclick="createNewSubmission()">
                                <i class="fas fa-plus me-1"></i>Submit More Trips
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Previous Submissions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Submissions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Reports Created</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="previous-submissions">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No previous submissions</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Creating Expense Reports</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar" id="modal-progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="modal-progress-text">Starting submission process...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/concur.js"></script>
    <script>
        let selectedTrips = [];
        let submissionInProgress = false;
        let currentTaskId = null;

        // Trip Selection Functions
        function toggleTripSelection(tripId) {
            const checkbox = document.getElementById(`trip-${tripId}`);
            const tripCard = document.querySelector(`[data-trip="${tripId}"]`);
            
            if (checkbox.checked) {
                selectedTrips = selectedTrips.filter(id => id !== tripId);
                checkbox.checked = false;
                tripCard.classList.remove('selected');
            } else {
                selectedTrips.push(tripId);
                checkbox.checked = true;
                tripCard.classList.add('selected');
            }
            
            updateSelectionSummary();
            updateSubmissionSteps();
        }

        function selectAllTrips() {
            document.querySelectorAll('[data-trip]').forEach(card => {
                const tripId = parseInt(card.dataset.trip);
                const checkbox = document.getElementById(`trip-${tripId}`);
                
                if (!selectedTrips.includes(tripId)) {
                    selectedTrips.push(tripId);
                    checkbox.checked = true;
                    card.classList.add('selected');
                }
            });
            
            updateSelectionSummary();
            updateSubmissionSteps();
        }

        function clearAllSelections() {
            selectedTrips = [];
            document.querySelectorAll('[data-trip]').forEach(card => {
                const tripId = parseInt(card.dataset.trip);
                const checkbox = document.getElementById(`trip-${tripId}`);
                
                checkbox.checked = false;
                card.classList.remove('selected');
            });
            
            updateSelectionSummary();
            updateSubmissionSteps();
        }

        function updateSelectionSummary() {
            // Update step indicators and enable/disable buttons based on selection
            const step1 = document.getElementById('step-1');
            const step1Indicator = step1.querySelector('.step-indicator');
            
            if (selectedTrips.length > 0) {
                step1.classList.add('completed');
                step1Indicator.classList.add('completed');
                step1Indicator.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                step1.classList.remove('completed');
                step1Indicator.classList.remove('completed');
                step1Indicator.textContent = '1';
            }
        }

        function updateSubmissionSteps() {
            // Enable validation if trips are selected
            if (selectedTrips.length > 0) {
                validateSelectedTrips();
            }
        }

        // Validation Functions
        function validateSelectedTrips() {
            const validationSection = document.getElementById('validation-section');
            const validationResults = document.getElementById('validation-results');
            
            fetch('/api/validate-trips', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trip_ids: selectedTrips })
            })
            .then(response => response.json())
            .then(data => {
                displayValidationResults(data);
                validationSection.style.display = 'block';
                
                const step2 = document.getElementById('step-2');
                const step2Indicator = step2.querySelector('.step-indicator');
                
                if (data.has_errors) {
                    step2.classList.add('error');
                    step2Indicator.classList.add('error');
                    step2Indicator.innerHTML = '<i class="fas fa-times"></i>';
                } else if (data.has_warnings) {
                    step2.classList.add('active');
                    step2Indicator.classList.add('active');
                    step2Indicator.innerHTML = '<i class="fas fa-exclamation"></i>';
                } else {
                    step2.classList.add('completed');
                    step2Indicator.classList.add('completed');
                    step2Indicator.innerHTML = '<i class="fas fa-check"></i>';
                    
                    // Show preview
                    showConcurPreview();
                }
            });
        }

        function displayValidationResults(data) {
            const resultsDiv = document.getElementById('validation-results');
            let html = '';
            
            if (data.errors && data.errors.length > 0) {
                html += '<div class="validation-error p-3 rounded mb-3">';
                html += '<h6><i class="fas fa-times-circle me-2"></i>Errors (Must Fix)</h6>';
                html += '<ul class="mb-0">';
                data.errors.forEach(error => {
                    html += `<li>${error}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (data.warnings && data.warnings.length > 0) {
                html += '<div class="policy-warning p-3 rounded mb-3">';
                html += '<h6><i class="fas fa-exclamation-triangle me-2"></i>Warnings</h6>';
                html += '<ul class="mb-0">';
                data.warnings.forEach(warning => {
                    html += `<li>${warning}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (!data.errors || data.errors.length === 0) {
                if (!data.warnings || data.warnings.length === 0) {
                    html += '<div class="submission-success p-3 rounded">';
                    html += '<h6><i class="fas fa-check-circle me-2"></i>All Good!</h6>';
                    html += '<p class="mb-0">Selected trips are ready for submission to Concur.</p>';
                    html += '</div>';
                }
            }
            
            resultsDiv.innerHTML = html;
        }

        // Preview Functions
        function showConcurPreview() {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('concur-preview-content');
            
            fetch('/api/preview-concur-reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trip_ids: selectedTrips })
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                
                data.reports.forEach((report, index) => {
                    html += `
                        <div class="concur-preview mb-4 p-3 rounded">
                            <h6>Report ${index + 1}: ${report.name}</h6>
                            <p class="text-muted">${report.business_purpose}</p>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Expense Type</th>
                                                <th>Vendor</th>
                                                <th>Amount</th>
                                                <th>Receipt</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    report.expenses.forEach(expense => {
                        html += `
                            <tr>
                                <td>${expense.date}</td>
                                <td>${expense.expense_type}</td>
                                <td>${expense.vendor}</td>
                                <td>$${expense.amount.toFixed(2)}</td>
                                <td>${expense.has_receipt ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-end">
                                        <h5>Total: $${report.total_amount.toFixed(2)}</h5>
                                        <p class="text-muted">${report.expense_count} expenses</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                previewContent.innerHTML = html;
                previewSection.style.display = 'block';
            });
        }

        // Submission Functions
        function createConcurReports() {
            if (submissionInProgress) return;
            
            submissionInProgress = true;
            
            const autoSubmit = document.getElementById('auto-submit-checkbox').checked;
            const attachReceipts = document.getElementById('attach-receipts-checkbox').checked;
            
            // Show progress modal
            new bootstrap.Modal(document.getElementById('progressModal')).show();
            
            fetch('/api/create-concur-reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    trip_ids: selectedTrips,
                    submit_reports: autoSubmit,
                    attach_receipts: attachReceipts
                })
            })
            .then(response => response.json())
            .then(data => {
                currentTaskId = data.task_id;
                pollSubmissionProgress();
            })
            .catch(error => {
                submissionInProgress = false;
                bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
                alert(`Submission failed: ${error.message}`);
            });
        }

        function pollSubmissionProgress() {
            if (!currentTaskId) return;
            
            fetch(`/api/task-status/${currentTaskId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgressModal(data.progress, data.description);
                    
                    if (data.status === 'running') {
                        setTimeout(pollSubmissionProgress, 2000);
                    } else if (data.status === 'completed') {
                        submissionInProgress = false;
                        bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
                        showSubmissionResults(data.result);
                    } else if (data.status === 'error') {
                        submissionInProgress = false;
                        bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
                        alert(`Submission failed: ${data.error}`);
                    }
                });
        }

        function updateProgressModal(progress, message) {
            document.getElementById('modal-progress-bar').style.width = `${progress}%`;
            document.getElementById('modal-progress-text').textContent = message;
        }

        function showSubmissionResults(results) {
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('submission-results');
            
            let html = '';
            let successCount = 0;
            let errorCount = 0;
            
            if (results.created_reports) {
                results.created_reports.forEach(report => {
                    if (report.status === 'created' || report.status === 'submitted') {
                        successCount++;
                        html += `
                            <div class="submission-success p-3 rounded mb-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${report.trip_location}</strong>
                                    <br><small>Report ID: ${report.report_id}</small>
                                    <br><small>Amount: $${report.amount.toFixed(2)}</small>
                                </div>
                                <div>
                                    <span class="badge bg-success">${report.status}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        errorCount++;
                        html += `
                            <div class="validation-error p-3 rounded mb-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${report.trip_location}</strong>
                                    <br><small>Error: ${report.error}</small>
                                </div>
                                <div>
                                    <span class="badge bg-danger">Failed</span>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            // Add summary
            html = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-success">${successCount}</h4>
                            <small>Reports Created</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-danger">${errorCount}</h4>
                            <small>Failures</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-primary">${selectedTrips.length}</h4>
                            <small>Total Processed</small>
                        </div>
                    </div>
                </div>
            ` + html;
            
            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';
            
            // Update step indicators
            const step3 = document.getElementById('step-3');
            const step3Indicator = step3.querySelector('.step-indicator');
            const step4 = document.getElementById('step-4');
            const step4Indicator = step4.querySelector('.step-indicator');
            
            step3.classList.add('completed');
            step3Indicator.classList.add('completed');
            step3Indicator.innerHTML = '<i class="fas fa-check"></i>';
            
            step4.classList.add('completed');
            step4Indicator.classList.add('completed');
            step4Indicator.innerHTML = '<i class="fas fa-check"></i>';
        }

        // Utility Functions
        function testConcurConnection() {
            const indicator = document.getElementById('connection-indicator');
            const message = document.getElementById('connection-message');
            
            indicator.className = 'fas fa-spinner fa-spin text-primary';
            message.textContent = 'Testing connection...';
            
            fetch('/api/test-concur-connection', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        indicator.className = 'fas fa-circle text-success';
                        message.textContent = `Connected as: ${data.user}`;
                    } else {
                        indicator.className = 'fas fa-circle text-danger';
                        message.textContent = `Connection failed: ${data.message}`;
                    }
                })
                .catch(error => {
                    indicator.className = 'fas fa-circle text-danger';
                    message.textContent = 'Connection test failed';
                });
        }

        function refreshConnection() {
            testConcurConnection();
        }

        function submitAllReady() {
            // Auto-select all ready trips and submit
            const readyTrips = [];
            document.querySelectorAll('.trip-preview .badge-success').forEach(badge => {
                const tripCard = badge.closest('.trip-preview');
                const tripId = parseInt(tripCard.dataset.trip);
                readyTrips.push(tripId);
            });
            
            if (readyTrips.length === 0) {
                alert('No trips are ready for submission. Please review and fix any issues first.');
                return;
            }
            
            selectedTrips = readyTrips;
            updateSelectionSummary();
            createConcurReports();
        }

        function fixIssuesAutomatically() {
            alert('Auto-fix feature coming soon! Please manually resolve issues for now.');
        }

        function proceedWithWarnings() {
            showConcurPreview();
        }

        function cancelSubmission() {
            selectedTrips = [];
            clearAllSelections();
            document.getElementById('validation-section').style.display = 'none';
            document.getElementById('preview-section').style.display = 'none';
        }

        function exportForManualEntry() {
            window.open('/api/export-concur-data?trip_ids=' + selectedTrips.join(','));
        }

        function saveAsDraft() {
            alert('Draft save feature coming soon!');
        }

        function viewInConcur() {
            window.open('https://www.concursolutions.com', '_blank');
        }

        function downloadSubmissionReport() {
            window.location.href = '/api/export-submission-report';
        }

        function createNewSubmission() {
            location.reload();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            testConcurConnection();
            loadPreviousSubmissions();
            
            // Set active step
            document.getElementById('step-1').classList.add('active');
            document.getElementById('step-1').querySelector('.step-indicator').classList.add('active');
        });

        function loadPreviousSubmissions() {
            fetch('/api/submission-history')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('previous-submissions');
                    
                    if (data.submissions && data.submissions.length > 0) {
                        tbody.innerHTML = '';
                        data.submissions.forEach(submission => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${submission.date}</td>
                                <td>${submission.report_count}</td>
                                <td>$${submission.total_amount.toFixed(2)}</td>
                                <td><span class="badge bg-${submission.status === 'completed' ? 'success' : 'warning'}">${submission.status}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewSubmission('${submission.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });
        }

        function viewSubmission(submissionId) {
            // Implementation for viewing submission details
            alert(`Viewing submission ${submissionId}`);
        }
    </script>
</body>
</html>