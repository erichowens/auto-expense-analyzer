<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Review - Travel Expense Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .expense-row:hover { background-color: #f8f9fa; }
        .work-expense { border-left: 4px solid #198754; }
        .personal-expense { border-left: 4px solid #dc3545; }
        .unclear-expense { border-left: 4px solid #ffc107; }
        .category-badge { font-size: 0.8em; }
        .edit-inline { display: none; }
        .amount-large { font-size: 1.2em; font-weight: bold; }
        .needs-review { background-color: #fff3cd; }
        .transaction-details { font-size: 0.9em; }
        .business-purpose-input { min-width: 200px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-calculator me-2"></i>Travel Expense Analyzer</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Dashboard</a>
                <a class="nav-link" href="/setup"><i class="fas fa-cog me-1"></i>Setup</a>
                <a class="nav-link active" href="/trips"><i class="fas fa-plane me-1"></i>Trips</a>
                <a class="nav-link" href="/receipts"><i class="fas fa-receipt me-1"></i>Receipts</a>
                <a class="nav-link" href="/concur"><i class="fas fa-upload me-1"></i>Submit to Concur</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Trip Review & Classification</h1>
                <p class="text-muted">Review and categorize expenses as business or personal</p>
            </div>
        </div>

        <!-- Review Status Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Review Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-success" id="ready-count">0</h4>
                                    <small>Ready for Concur</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-warning" id="review-count">0</h4>
                                    <small>Needs Review</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-danger" id="personal-count">0</h4>
                                    <small>Personal Expenses</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-info" id="total-business">$0.00</h4>
                                    <small>Business Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Cards -->
        <div class="row">
            {% for trip in trips %}
            <div class="col-12 mb-4">
                <div class="card" id="trip-{{ trip.trip_number }}">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <span class="editable-field" data-field="primary_location" data-trip="{{ trip.trip_number }}">
                                        {{ trip.primary_location }}
                                    </span>
                                </h5>
                                <small class="text-muted">
                                    <span class="editable-field" data-field="start_date" data-trip="{{ trip.trip_number }}">
                                        {{ trip.start_date }}
                                    </span> to 
                                    <span class="editable-field" data-field="end_date" data-trip="{{ trip.trip_number }}">
                                        {{ trip.end_date }}
                                    </span>
                                    ({{ trip.duration_days }} days)
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="amount-large text-primary">${{ "%.2f"|format(trip.total_amount) }}</div>
                                <small class="text-muted">{{ trip.transaction_count }} transactions</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Business Purpose -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Business Purpose</label>
                                <div class="input-group">
                                    <input type="text" class="form-control business-purpose-input" 
                                           placeholder="Enter business purpose for this trip..."
                                           data-trip="{{ trip.trip_number }}"
                                           id="business-purpose-{{ trip.trip_number }}">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="suggestBusinessPurpose({{ trip.trip_number }})">
                                        <i class="fas fa-lightbulb"></i> Suggest
                                    </button>
                                </div>
                                <div class="form-text">
                                    <strong>⚠️ Required for Concur submission.</strong> 
                                    Common examples: "Client meeting", "Conference attendance", "Site visit"
                                </div>
                            </div>
                        </div>

                        <!-- Trip Classification -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Trip Classification</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="trip-type-{{ trip.trip_number }}" 
                                           id="business-{{ trip.trip_number }}" value="business" checked>
                                    <label class="btn btn-outline-success" for="business-{{ trip.trip_number }}">
                                        <i class="fas fa-briefcase me-1"></i>Business Trip
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="trip-type-{{ trip.trip_number }}" 
                                           id="mixed-{{ trip.trip_number }}" value="mixed">
                                    <label class="btn btn-outline-warning" for="mixed-{{ trip.trip_number }}">
                                        <i class="fas fa-question me-1"></i>Mixed Business/Personal
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="trip-type-{{ trip.trip_number }}" 
                                           id="personal-{{ trip.trip_number }}" value="personal">
                                    <label class="btn btn-outline-danger" for="personal-{{ trip.trip_number }}">
                                        <i class="fas fa-user me-1"></i>Personal Trip
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Breakdown -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>Expense Categories</h6>
                                <div class="row">
                                    {% for category, amount in trip.category_breakdown.items() %}
                                    <div class="col-md-3 mb-2">
                                        <div class="border rounded p-2 text-center">
                                            <div class="fw-bold">{{ category }}</div>
                                            <div class="text-primary">${{ "%.2f"|format(amount) }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Individual Transactions -->
                        <div class="row">
                            <div class="col-12">
                                <h6>Individual Expenses 
                                    <button class="btn btn-sm btn-outline-secondary ms-2" 
                                            onclick="toggleTransactions({{ trip.trip_number }})">
                                        <i class="fas fa-eye"></i> Show/Hide Details
                                    </button>
                                </h6>
                                
                                <div class="transaction-list" id="transactions-{{ trip.trip_number }}" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Description</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                    <th>Business/Personal</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for transaction in trip.transactions %}
                                                <tr class="expense-row {% if transaction.category == 'OTHER' %}needs-review{% endif %}" 
                                                    data-trip="{{ trip.trip_number }}" data-transaction="{{ loop.index0 }}">
                                                    <td>{{ transaction.date.strftime('%m/%d') }}</td>
                                                    <td>
                                                        <div class="transaction-details">
                                                            <strong>{{ transaction.description[:40] }}{% if transaction.description|length > 40 %}...{% endif %}</strong>
                                                            {% if transaction.location %}
                                                            <br><small class="text-muted">
                                                                <i class="fas fa-map-marker-alt"></i> {{ transaction.location }}
                                                            </small>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm category-select" 
                                                                data-trip="{{ trip.trip_number }}" data-transaction="{{ loop.index0 }}">
                                                            <option value="HOTEL" {% if transaction.category == 'HOTEL' %}selected{% endif %}>Hotel</option>
                                                            <option value="AIRFARE" {% if transaction.category == 'AIRFARE' %}selected{% endif %}>Airfare</option>
                                                            <option value="MEALS" {% if transaction.category == 'MEALS' %}selected{% endif %}>Meals</option>
                                                            <option value="TRANSPORTATION" {% if transaction.category == 'TRANSPORTATION' %}selected{% endif %}>Transportation</option>
                                                            <option value="OTHER" {% if transaction.category == 'OTHER' %}selected{% endif %}>Other</option>
                                                        </select>
                                                        {% if transaction.category == 'OTHER' %}
                                                        <small class="text-warning">
                                                            <i class="fas fa-exclamation-triangle"></i> Needs categorization
                                                        </small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="amount-large">${{ "%.2f"|format(transaction.amount) }}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <input type="radio" class="btn-check" 
                                                                   name="expense-type-{{ trip.trip_number }}-{{ loop.index0 }}" 
                                                                   id="biz-{{ trip.trip_number }}-{{ loop.index0 }}" 
                                                                   value="business" checked>
                                                            <label class="btn btn-outline-success btn-sm" 
                                                                   for="biz-{{ trip.trip_number }}-{{ loop.index0 }}">
                                                                Business
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check" 
                                                                   name="expense-type-{{ trip.trip_number }}-{{ loop.index0 }}" 
                                                                   id="personal-{{ trip.trip_number }}-{{ loop.index0 }}" 
                                                                   value="personal">
                                                            <label class="btn btn-outline-danger btn-sm" 
                                                                   for="personal-{{ trip.trip_number }}-{{ loop.index0 }}">
                                                                Personal
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" 
                                                                onclick="editTransaction({{ trip.trip_number }}, {{ loop.index0 }})">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info" 
                                                                onclick="viewReceipt({{ trip.trip_number }}, {{ loop.index0 }})">
                                                            <i class="fas fa-receipt"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <button class="btn btn-success" onclick="markTripReady({{ trip.trip_number }})">
                                            <i class="fas fa-check me-1"></i>Mark Ready for Concur
                                        </button>
                                        <button class="btn btn-warning" onclick="flagForReview({{ trip.trip_number }})">
                                            <i class="fas fa-flag me-1"></i>Flag for Manual Review
                                        </button>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-primary" onclick="previewConcurReport({{ trip.trip_number }})">
                                            <i class="fas fa-eye me-1"></i>Preview Concur Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Bulk Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Bulk Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success" onclick="markAllBusinessReady()">
                                <i class="fas fa-check-double me-1"></i>Mark All Business Trips Ready
                            </button>
                            <button class="btn btn-warning" onclick="autoCategorizeMissing()">
                                <i class="fas fa-magic me-1"></i>Auto-Categorize Missing
                            </button>
                            <button class="btn btn-info" onclick="exportReviewData()">
                                <i class="fas fa-download me-1"></i>Export Review Data
                            </button>
                            <button class="btn btn-primary" onclick="proceedToConcur()">
                                <i class="fas fa-arrow-right me-1"></i>Proceed to Concur Submission
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Edit Modal -->
    <div class="modal fade" id="transactionEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionEditForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Vendor Name</label>
                                <input type="text" class="form-control" id="edit-vendor">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="edit-amount" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="edit-category">
                                    <option value="HOTEL">Hotel</option>
                                    <option value="AIRFARE">Airfare</option>
                                    <option value="MEALS">Meals</option>
                                    <option value="TRANSPORTATION">Transportation</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Business Purpose</label>
                                <input type="text" class="form-control" id="edit-purpose" 
                                       placeholder="Specific purpose for this expense">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="edit-notes" rows="3" 
                                          placeholder="Additional notes or clarifications"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransactionEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEditTrip = null;
        let currentEditTransaction = null;

        function toggleTransactions(tripId) {
            const element = document.getElementById(`transactions-${tripId}`);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }

        function suggestBusinessPurpose(tripId) {
            const purposes = [
                "Client meeting and project review",
                "Conference attendance and networking",
                "Site visit and facility inspection",
                "Training and professional development",
                "Sales presentation and proposal",
                "Team collaboration and planning",
                "Vendor meeting and contract negotiation"
            ];
            
            const randomPurpose = purposes[Math.floor(Math.random() * purposes.length)];
            document.getElementById(`business-purpose-${tripId}`).value = randomPurpose;
        }

        function editTransaction(tripId, transactionId) {
            currentEditTrip = tripId;
            currentEditTransaction = transactionId;
            
            // Populate modal with current values
            // This would fetch actual transaction data
            new bootstrap.Modal(document.getElementById('transactionEditModal')).show();
        }

        function saveTransactionEdit() {
            const updates = {
                vendor_name: document.getElementById('edit-vendor').value,
                amount: parseFloat(document.getElementById('edit-amount').value),
                category: document.getElementById('edit-category').value,
                business_purpose: document.getElementById('edit-purpose').value,
                notes: document.getElementById('edit-notes').value
            };
            
            fetch(`/api/transactions/${currentEditTrip}/${currentEditTransaction}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('transactionEditModal')).hide();
                location.reload(); // Refresh to show changes
            });
        }

        function viewReceipt(tripId, transactionId) {
            // Open receipt viewer
            window.open(`/receipts#trip-${tripId}-transaction-${transactionId}`, '_blank');
        }

        function markTripReady(tripId) {
            const businessPurpose = document.getElementById(`business-purpose-${tripId}`).value;
            
            if (!businessPurpose.trim()) {
                alert('Please enter a business purpose before marking this trip as ready.');
                document.getElementById(`business-purpose-${tripId}`).focus();
                return;
            }
            
            // Update trip status
            fetch(`/api/trips/${tripId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    business_purpose: businessPurpose,
                    status: 'ready' 
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Trip marked as ready for Concur submission!');
                updateReviewCounts();
            });
        }

        function flagForReview(tripId) {
            const reason = prompt('Why does this trip need manual review?');
            if (reason) {
                // Flag trip for review
                alert(`Trip ${tripId} flagged for review: ${reason}`);
            }
        }

        function previewConcurReport(tripId) {
            window.open(`/api/preview-concur-report/${tripId}`, '_blank');
        }

        function markAllBusinessReady() {
            if (confirm('Mark all business trips as ready for Concur submission?')) {
                // Implementation would mark all business trips as ready
                alert('All business trips marked as ready!');
            }
        }

        function autoCategorizeMissing() {
            // Auto-categorize transactions marked as 'OTHER'
            document.querySelectorAll('.category-select').forEach(select => {
                if (select.value === 'OTHER') {
                    // Simple auto-categorization logic
                    const description = select.closest('tr').querySelector('.transaction-details strong').textContent.toLowerCase();
                    
                    if (description.includes('hotel') || description.includes('marriott') || description.includes('hilton')) {
                        select.value = 'HOTEL';
                    } else if (description.includes('airline') || description.includes('delta') || description.includes('united')) {
                        select.value = 'AIRFARE';
                    } else if (description.includes('restaurant') || description.includes('starbucks') || description.includes('mcdonald')) {
                        select.value = 'MEALS';
                    } else if (description.includes('uber') || description.includes('taxi') || description.includes('rental')) {
                        select.value = 'TRANSPORTATION';
                    }
                }
            });
            
            alert('Auto-categorization complete! Please review the changes.');
        }

        function exportReviewData() {
            window.location.href = '/api/export-data';
        }

        function proceedToConcur() {
            window.location.href = '/concur';
        }

        function updateReviewCounts() {
            // Update the summary counts at the top
            // This would calculate from current page data
        }

        // Handle category changes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('category-select')) {
                const tripId = e.target.dataset.trip;
                const transactionId = e.target.dataset.transaction;
                const newCategory = e.target.value;
                
                fetch(`/api/transactions/${tripId}/${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: newCategory })
                });
                
                // Remove needs-review styling if category is no longer OTHER
                const row = e.target.closest('.expense-row');
                if (newCategory !== 'OTHER') {
                    row.classList.remove('needs-review');
                } else {
                    row.classList.add('needs-review');
                }
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateReviewCounts();
        });
    </script>
</body>
</html>